version: 1.0
runtime: ruby31

build:
  env:
    - name: BUNDLE_WITHOUT
      value: "development:test"
    - name: BUNDLE_DEPLOYMENT
      value: "1"
    - name: BUNDLE_FORCE_RUBY_PLATFORM
      value: "1"
    - name: BUNDLE_BUILD__PSYCH
      value: "--with-libyaml-dir=/usr"
    - name: BUNDLE_BUILD__MYSQL2
      value: "--with-mysql-config=/usr/bin/mysql_config"
  commands:
    build:
      - yum -y install libyaml-devel mariadb-devel gcc make pkgconfig
      - gem install bundler -v 2.6.9
      - bundle _2.6.9_ config set path 'vendor/bundle'
      - bundle _2.6.9_ install --jobs 4 --retry 3

run:
  runtime-version: 3.1.7
  command: >
    bash -lc 'set -e;
      export RAILS_ENV=${RAILS_ENV:-production};
      : "${SECRET_KEY_BASE:?}"; : "${DATABASE_URL:?}";
      if [ -f config/puma.rb ]; then PUMA_OPTS="-C config/puma.rb"; else PUMA_OPTS=""; fi;
      exec bundle _2.6.9_ exec puma $PUMA_OPTS -b tcp://0.0.0.0:${PORT:-8080}'
  network:
    port: 8080